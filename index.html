<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brawl Stars: Batalla Infinita</title>

    <!-- Meta Tags para compartir en redes sociales (WhatsApp, etc.) -->
    <meta property="og:title" content="Brawl Stars: Batalla Infinita">
    <meta property="og:description" content="¬°Un juego de decisiones t√°cticas! ¬øCu√°ntos asaltos podr√°s aguantar?">
    <!-- IMPORTANTE: Reemplaza la siguiente URL con la URL real de tu logo en GitHub -->
    <meta property="og:image" content="https://raw.githubusercontent.com/aitor88/repo/main/imagenes/logo.png">
    <meta property="og:type" content="website">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@700&display=swap" rel="stylesheet">
    
    <!-- SCRIPTS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #1a202c; }
        .font-title { font-family: 'Lilita One', cursive; }
        .stat-bar-inner { transition: width 0.5s ease-in-out; }
        .game-container { max-width: 500px; width: 100%; height: 100vh; max-height: 900px; display: flex; flex-direction: column; }
        .choice-button, .menu-button { transition: background-color 0.2s, transform 0.2s; border-bottom-width: 4px; display: flex; align-items: center; justify-content: center; padding: 8px; }
        .choice-button:hover, .menu-button:hover { transform: translateY(-2px); }
        .choice-button:active, .menu-button:active { transform: translateY(1px); }
        #super-button:disabled { filter: grayscale(80%); cursor: not-allowed; }
        #game-overlay, #resolution-overlay, #notification, #splash-screen { transition: opacity 0.5s; }
        .hidden-overlay { opacity: 0; pointer-events: none; }
        #player-name-input { background-color: #2d3748; border: 2px solid #4a5568; color: white; border-radius: 0.5rem; padding: 0.75rem; text-align: center; font-size: 16px; }
        .inventory-item { height: 100%; width: auto; max-height: 40px; }

        #splash-logo { width: 300px; position: relative; opacity: 0; transform: translateY(-200px) scale(2) rotate(10deg); animation: dropIn 1.2s ease-out forwards; }
        @keyframes dropIn { 0% { opacity: 0; transform: translateY(-200px) scale(2.5) rotate(10deg); filter: blur(20px); } 60% { opacity: 1; transform: translateY(20px) scale(1.05) rotate(-3deg); filter: blur(0px); } 80% { transform: translateY(-5px) scale(1.02); } 100% { transform: translateY(0px) scale(1); } }
        #splash-logo.shake { animation: shake 0.2s ease-in-out 1; }
        @keyframes shake { 0% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-4px) rotate(1deg); } 50% { transform: translateY(4px) rotate(-1deg); } 75% { transform: translateY(-2px) rotate(0.5deg); } 100% { transform: translateY(0) rotate(0); } }
        
        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table th, .ranking-table td { padding: 8px; text-align: center; }
        .ranking-table th { color: #facc15; }
        .ranking-table tr:not(:last-child) { border-bottom: 1px solid #4a5568; }
        .ranking-table td:nth-child(2), .ranking-table th:nth-child(2) { text-align: left; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- Pantalla de Bienvenida (Splash Screen) -->
    <div id="splash-screen" class="absolute inset-0 flex items-center justify-center bg-slate-900 z-50">
        <img id="splash-logo" src="imagenes/logo.png" alt="Brawl Stars: Batalla Infinita">
        <audio id="impact-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_02f51f27f9.mp3"></audio>
    </div>

    <!-- Contenedor Principal del Juego (Oculto al inicio) -->
    <div id="game-container" class="hidden game-container bg-gray-800 rounded-3xl shadow-2xl p-3 sm:p-6 flex-col justify-between relative overflow-hidden">
        
        <div id="game-ui" class="hidden h-full flex flex-col">
            <div id="stats-container" class="space-y-1.5">
                <div class="flex justify-between items-center font-title text-base">
                    <div><span class="text-yellow-300">JUGADOR:&nbsp;</span><span id="player-name-display" class="text-green-400 uppercase"></span></div>
                    <div class="text-yellow-300"><span>ASALTO </span><span id="assault-counter">1</span></div>
                </div>
                <div class="stat"><div class="flex justify-between items-center"><span class="text-sm font-bold text-green-400">‚ù§Ô∏è VIDA</span><span id="health-text" class="text-sm font-bold"></span></div><div class="w-full bg-gray-700 rounded-full h-2"><div id="health-bar" class="bg-green-500 h-2 rounded-full stat-bar-inner"></div></div></div>
                <div class="stat"><div class="flex justify-between items-center"><span class="text-sm font-bold text-orange-400">üí• ATAQUE</span><span id="attack-text" class="text-sm font-bold"></span></div><div class="w-full bg-gray-700 rounded-full h-2"><div id="attack-bar" class="bg-orange-500 h-2 rounded-full stat-bar-inner"></div></div></div>
                <div class="stat"><div class="flex justify-between items-center"><span class="text-sm font-bold text-sky-400">üõ°Ô∏è DEFENSA</span><span id="defense-text" class="text-sm font-bold"></span></div><div class="w-full bg-gray-700 rounded-full h-2"><div id="defense-bar" class="bg-sky-500 h-2 rounded-full stat-bar-inner"></div></div></div>
                <div class="stat"><div class="flex justify-between items-center"><span class="text-sm font-bold text-yellow-400">üåü SUPERPODER</span><span id="super-text" class="text-sm font-bold"></span></div><div class="w-full bg-gray-700 rounded-full h-2"><div id="super-bar" class="bg-yellow-400 h-2 rounded-full stat-bar-inner"></div></div></div>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center my-2 sm:my-4 relative">
                <div id="dilemma-card" class="bg-gray-700 rounded-2xl shadow-xl p-4 w-full max-w-sm text-center flex flex-col items-center justify-center flex-grow">
                    <img id="char-img" src="" class="w-28 h-28 sm:w-36 sm:h-36 rounded-full object-cover mb-2 border-4 border-gray-600" alt="Personaje">
                    <h2 id="char-name" class="font-title text-2xl sm:text-3xl text-yellow-300 mb-1"></h2>
                    <p id="dilemma-description" class="text-gray-200 text-lg sm:text-xl font-bold"></p>
                </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 my-2">
                <button id="super-button" class="choice-button w-1/3 bg-yellow-500 border-yellow-700 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-2 rounded-xl text-base sm:text-lg font-title">SUPER</button>
                <div id="inventory-container" class="flex-grow bg-gray-900/50 h-14 rounded-lg flex items-center justify-start p-2 gap-2 overflow-x-auto"></div>
            </div>
            <div id="choices-section" class="grid grid-cols-2 gap-2 sm:gap-3">
                <button id="choice-1" class="choice-button bg-red-600 border-red-800 hover:bg-red-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
                <button id="choice-2" class="choice-button bg-blue-600 border-blue-800 hover:bg-blue-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
            </div>
            <div id="challenge-choices-section" class="hidden grid grid-cols-2 gap-2 sm:gap-3 mt-2">
                 <button id="challenge-choice-1" class="choice-button bg-gray-600 border-gray-800 hover:bg-gray-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
                 <button id="challenge-choice-2" class="choice-button bg-gray-600 border-gray-800 hover:bg-gray-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
                 <button id="challenge-choice-3" class="choice-button bg-gray-600 border-gray-800 hover:bg-gray-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
                 <button id="challenge-choice-4" class="choice-button bg-gray-600 border-gray-800 hover:bg-gray-500 text-white font-bold rounded-xl text-sm sm:text-base"></button>
            </div>
        </div>
        <div id="resolution-overlay" class="hidden-overlay absolute inset-0 bg-slate-800 flex flex-col items-center justify-center text-center p-6 rounded-3xl z-30"><h1 id="resolution-title" class="font-title text-3xl sm:text-4xl mb-3 text-yellow-300"></h1><p id="resolution-narrative" class="text-lg sm:text-xl mb-4 font-bold"></p><div id="resolution-effects" class="text-left space-y-1 mb-6 text-lg font-bold"></div><button id="resolution-continue" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full text-lg sm:text-xl font-title">Continuar</button></div>
        <div id="game-overlay" class="absolute inset-0 bg-slate-800 flex flex-col items-center justify-center text-center p-6 rounded-3xl z-20 hidden-overlay"></div>
        <div id="notification" class="hidden-overlay absolute bottom-24 left-1/2 -translate-x-1/2 bg-red-600 text-white font-bold py-2 px-5 rounded-lg shadow-lg pointer-events-none font-title">¬°No tienes superpoder suficiente!</div>
    </div>

    <!-- CARGA DE DATOS -->
    <script>
        window.gameCharacters = [];
        window.gameEvents = [];
        window.gameChallenges = [];
    </script>
    <script src="datos/shelly_data.js"></script>
    <script src="datos/poco_data.js"></script>
    <script src="datos/el_primo_data.js"></script>
    <script src="datos/leon_data.js"></script>
    <script src="datos/eventos_data.js"></script>
    <script src="datos/retos_data.js"></script>

    <!-- MOTOR DEL JUEGO -->
    <script>
        // ===================================================================
        // === INICIALIZACI√ìN DE FIREBASE ===
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDFhLfNxTGZqPa8BEDhDJ9GMqUXkBCYAn0",
            authDomain: "juego-brawl-stars-ranking.firebaseapp.com",
            projectId: "juego-brawl-stars-ranking",
            storageBucket: "juego-brawl-stars-ranking.firebasestorage.app",
            messagingSenderId: "11560476574",
            appId: "1:11560476574:web:0603074665db720fdd008f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ESTADO DEL JUEGO ---
        let stats = { vida: 80, ataque: 20, defensa: 20, superpoder: 0 };
        let currentAssault = 1;
        let gameOver = false;
        let isSpecialTurn = false; 
        let playerName = '';
        let inventory = [];
        const characters = window.gameCharacters;
        const events = window.gameEvents;
        const challenges = window.gameChallenges;

        // --- L√ìGICA ANTI-REPETICI√ìN ---
        let lastCharacterName = '';
        let lastEventName = '';
        let dilemmaDecks = {};

        const ui = {
            splashScreen: document.getElementById('splash-screen'),
            splashLogo: document.getElementById('splash-logo'),
            impactSound: document.getElementById('impact-sound'),
            gameContainer: document.getElementById('game-container'),
            gameUI: document.getElementById('game-ui'),
            assaultCounter: document.getElementById('assault-counter'), playerNameDisplay: document.getElementById('player-name-display'),
            healthBar: document.getElementById('health-bar'), healthText: document.getElementById('health-text'),
            attackBar: document.getElementById('attack-bar'), attackText: document.getElementById('attack-text'),
            defenseBar: document.getElementById('defense-bar'), defenseText: document.getElementById('defense-text'),
            superBar: document.getElementById('super-bar'), superText: document.getElementById('super-text'),
            charImg: document.getElementById('char-img'), charName: document.getElementById('char-name'),
            dilemmaDescription: document.getElementById('dilemma-description'),
            choicesSection: document.getElementById('choices-section'), choice1: document.getElementById('choice-1'), choice2: document.getElementById('choice-2'),
            challengeChoicesSection: document.getElementById('challenge-choices-section'),
            superButton: document.getElementById('super-button'), notification: document.getElementById('notification'), 
            inventoryContainer: document.getElementById('inventory-container'),
            gameOverlay: document.getElementById('game-overlay'),
            resolutionOverlay: document.getElementById('resolution-overlay'), resolutionTitle: document.getElementById('resolution-title'), resolutionNarrative: document.getElementById('resolution-narrative'), resolutionEffects: document.getElementById('resolution-effects'), resolutionContinue: document.getElementById('resolution-continue'),
        };
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createDilemmaDecks() {
            dilemmaDecks = {};
            characters.forEach(char => {
                dilemmaDecks[char.name] = shuffleArray([...char.dilemmas]);
            });
        }

        function initGame() {
            playerName = document.getElementById('player-name-input').value.trim() || 'Brawler';
            stats = { vida: 80, ataque: 20, defensa: 20, superpoder: 0 };
            currentAssault = 1;
            gameOver = false;
            inventory = [];
            lastCharacterName = '';
            lastEventName = '';
            createDilemmaDecks();
            updateInventoryUI();
            ui.gameOverlay.classList.add('hidden-overlay');
            ui.gameUI.classList.remove('hidden');
            nextAssault();
        }

        function updateUI() {
            ui.assaultCounter.textContent = currentAssault;
            ui.playerNameDisplay.textContent = playerName;
            ui.healthBar.style.width = `${stats.vida}%`; ui.healthText.textContent = `${stats.vida}%`;
            ui.attackBar.style.width = `${stats.ataque}%`; ui.attackText.textContent = `${stats.ataque}%`;
            ui.defenseBar.style.width = `${stats.defensa}%`; ui.defenseText.textContent = `${stats.defensa}%`;
            ui.superBar.style.width = `${stats.superpoder}%`; ui.superText.textContent = `${stats.superpoder}%`;
            ui.superButton.disabled = stats.superpoder < 100;
        }

        function updateInventoryUI() {
            ui.inventoryContainer.innerHTML = '';
            if (inventory.length === 0) {
                const emptyText = document.createElement('span');
                emptyText.className = 'text-gray-500 text-sm italic px-2';
                emptyText.textContent = 'Inventario vac√≠o';
                ui.inventoryContainer.appendChild(emptyText);
            } else {
                inventory.forEach(item => {
                    const itemEl = document.createElement('img');
                    itemEl.className = 'inventory-item';
                    itemEl.src = item.image;
                    itemEl.title = item.name;
                    itemEl.onerror = () => { itemEl.style.display = 'none'; };
                    ui.inventoryContainer.appendChild(itemEl);
                });
            }
        }

        function nextAssault() {
            if (gameOver) return;
            ui.choicesSection.classList.remove('hidden');
            ui.challengeChoicesSection.classList.add('hidden');
            
            let char;
            do {
                char = characters[Math.floor(Math.random() * characters.length)];
            } while (char.name === lastCharacterName && characters.length > 1);
            lastCharacterName = char.name;

            if (dilemmaDecks[char.name].length === 0) {
                createDilemmaDecks(); // Reshuffle all decks if one runs out
            }
            const dilemma = dilemmaDecks[char.name].pop();
            
            ui.charImg.style.display = 'block';
            ui.charName.textContent = char.name;
            ui.charImg.src = char.img;
            ui.charImg.onerror = () => { ui.charImg.src = `https://placehold.co/150x150/cccccc/ffffff?text=${char.name.substring(0,2)}`; };
            ui.dilemmaDescription.innerHTML = dilemma.description;
            ui.choice1.textContent = dilemma.options[0].text;
            ui.choice2.textContent = dilemma.options[1].text;
            ui.choice1.onclick = () => chooseOption(dilemma.options[0], char.name);
            ui.choice2.onclick = () => chooseOption(dilemma.options[1], char.name);
            updateUI();
        }

        function chooseOption(action, charName) {
            if (gameOver) return;
            let combinedEffects = { ...action.effects };
            let narrative = action.narrative;
            const baseDamage = 3 + (currentAssault * 2); 
            const finalDamage = Math.max(1, baseDamage - Math.floor(stats.defensa / 5));
            combinedEffects.vida = (combinedEffects.vida || 0) - finalDamage;
            narrative += ` Los enemigos contraatacan.`;
            isSpecialTurn = false; 
            showResolution(charName, narrative, combinedEffects);
        }
        
        function useSuper() {
            if (stats.superpoder < 100) {
                ui.notification.classList.remove('hidden-overlay');
                setTimeout(() => { ui.notification.classList.add('hidden-overlay'); }, 2000);
                return;
            }
            const superEffects = { superpoder: -100, vida: 33, ataque: 33, defensa: 34 };
            isSpecialTurn = true;
            showResolution('¬°SUPERPODER!', '¬°Un impulso de poder refuerza todas tus capacidades por igual!', superEffects);
        }

        function showResolution(title, narrative, effects) {
            let effectDescriptions = [];
            for (const key in effects) {
                if (effects[key] === 0) continue;
                const value = effects[key];
                stats[key] = Math.round(stats[key] + value);
            }
            
            checkGameOver();
            if(gameOver) return;

            for (const key in effects) {
                stats[key] = Math.max(0, Math.min(100, stats[key]));
                const value = effects[key];
                const icon = {vida: '‚ù§Ô∏è', ataque: 'üí•', defensa: 'üõ°Ô∏è', superpoder: 'üåü'}[key];
                const name = {vida: 'Vida', ataque: 'Ataque', defensa: 'Defensa', superpoder: 'Superpoder'}[key];
                const change = value > 0 ? `+${value}%` : `${value}%`;
                const color = value > 0 ? 'text-green-400' : 'text-red-400';
                effectDescriptions.push(`<p class="${color}">${icon} ${name}: ${change}</p>`);
            }

            ui.resolutionTitle.textContent = title;
            ui.resolutionNarrative.innerHTML = narrative;
            ui.resolutionEffects.innerHTML = effectDescriptions.join('');
            ui.resolutionOverlay.classList.remove('hidden-overlay');
        }

        function handleContinueClick() {
            ui.resolutionOverlay.classList.add('hidden-overlay');
            if (!isSpecialTurn) {
                currentAssault++;
            }
            updateUI();
            checkGameOver();
            if (!gameOver) {
                const rand = Math.random();
                if (rand < 0.2 && events.length > 0) { 
                    triggerRandomEvent();
                } else if (rand < 0.35 && challenges.length > 0) {
                    triggerRandomChallenge();
                } else {
                    nextAssault();
                }
            }
        }

        function triggerRandomEvent() {
            let event;
            do {
                event = events[Math.floor(Math.random() * events.length)];
            } while (event.name === lastEventName && events.length > 1);
            lastEventName = event.name;

            isSpecialTurn = true;
            if (event.type === 'immediate') {
                showResolution(`¬°EVENTO: ${event.name}!`, event.narrative, event.effects);
            } else if (event.type === 'choice') {
                displayEventChoice(event);
            } else {
                nextAssault();
            }
        }

        function displayEventChoice(event) {
            ui.charImg.style.display = 'none';
            ui.charName.textContent = `¬°EVENTO: ${event.name}!`;
            ui.dilemmaDescription.innerHTML = event.message;
            ui.choice1.textContent = event.options[0].text;
            ui.choice2.textContent = event.options[1].text;
            ui.choice1.onclick = () => { showResolution(event.name, event.options[0].narrative, event.options[0].effects); };
            ui.choice2.onclick = () => { showResolution(event.name, event.options[1].narrative, event.options[1].effects); };
        }

        function triggerRandomChallenge() {
            const challenge = challenges[Math.floor(Math.random() * challenges.length)];
            isSpecialTurn = true;
            ui.choicesSection.classList.add('hidden');
            ui.challengeChoicesSection.classList.remove('hidden');
            ui.charImg.src = challenge.img;
            ui.charName.textContent = "¬°ACERTIJO!";
            ui.dilemmaDescription.innerHTML = challenge.challenge;
            const buttons = Array.from(ui.challengeChoicesSection.children);
            const shuffledOptions = [...challenge.options].sort(() => Math.random() - 0.5);
            buttons.forEach((button, index) => {
                const option = shuffledOptions[index];
                button.textContent = option.text;
                button.onclick = () => {
                    if (option.correct) {
                        inventory.push(challenge.reward);
                        updateInventoryUI();
                        showResolution("¬°CORRECTO!", challenge.success, { superpoder: 15 });
                    } else {
                        showResolution("¬°INCORRECTO!", challenge.failure, { vida: -5 });
                    }
                };
            });
        }

        function checkGameOver() {
            if (gameOver) return;
            let reason = null;
            if (stats.vida <= 0) reason = { title: '¬°Sin Vida!', text: 'La vida de tu escuadr√≥n ha llegado a cero.' };
            if (stats.ataque >= 100) reason = { title: '¬°Furia Descontrolada!', text: 'Tu ataque es tan alto que has destruido todo, ¬°incluido a ti mismo!' };
            if (stats.defensa >= 100) reason = { title: '¬°Fortaleza Inm√≥vil!', text: 'Tu defensa es tan perfecta que te has convertido en una estatua.' };

            if (reason) {
                showEndScreen(reason);
            }
        }

        function saveScore(name, score, collectibles) {
            db.collection("ranking").add({
                name: name,
                score: score,
                collectibles: collectibles
            }).catch(error => console.error("Error al guardar en Firebase: ", error));
        }

        function displayRanking(rankingListElement) {
            rankingListElement.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
            db.collection("ranking").orderBy("score", "desc").limit(5).get()
                .then((querySnapshot) => {
                    rankingListElement.innerHTML = '';
                    if (querySnapshot.empty) {
                        rankingListElement.innerHTML = '<tr><td colspan="4">¬°S√© el primero en jugar!</td></tr>';
                        return;
                    }
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const entry = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rank++}</td>
                            <td class="text-left">${entry.name.toUpperCase()}</td>
                            <td>${entry.collectibles || 0}</td>
                            <td>${entry.score}</td>
                        `;
                        rankingListElement.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar ranking: ", error);
                    rankingListElement.innerHTML = '<tr><td colspan="4">Error al cargar ranking.</td></tr>';
                });
        }

        function showEndScreen(reason) {
            gameOver = true;
            saveScore(playerName, currentAssault, inventory.length);
            ui.gameUI.classList.add('hidden');
            ui.gameOverlay.innerHTML = `
                <div class="w-full flex flex-col items-center justify-center h-full">
                    <img src="avatares/momoxorro.png" alt="Villano" class="w-28 h-28 sm:w-32 sm:h-32 mb-4 rounded-full" onerror="this.style.display='none'">
                    <h1 class="font-title text-4xl sm:text-5xl mb-2 text-yellow-300">¬°DERROTADO!</h1>
                    <p class="text-lg mb-2 text-red-400 font-bold">${reason.text}</p>
                    <p class="text-base sm:text-lg mb-2">Has aguantado <span class="font-bold text-yellow-300">${currentAssault}</span> asaltos.</p>
                    <p id="player-rank-text" class="text-base sm:text-lg mb-6">Calculando tu posici√≥n en el ranking...</p>
                    
                    <div class="w-full max-w-xs space-y-3 mt-auto">
                        <button onclick="showRankingScreen()" class="menu-button w-full bg-orange-500 border-orange-700 hover:bg-orange-400 text-white font-bold py-3 px-8 rounded-full text-xl font-title">Ver Ranking</button>
                        <button onclick="showMainMenu()" class="menu-button w-full bg-green-500 border-green-700 hover:bg-green-400 text-white font-bold py-3 px-8 rounded-full text-xl font-title">Men√∫ Principal</button>
                    </div>
                </div>
            `;
            
            db.collection("ranking").orderBy("score", "desc").get().then(querySnapshot => {
                let rank = 0;
                let found = false;
                querySnapshot.forEach((doc, index) => {
                    if (!found) {
                        const entry = doc.data();
                        if (entry.name === playerName && entry.score === currentAssault) {
                            rank = index + 1;
                            found = true; 
                        }
                    }
                });
                const rankText = document.getElementById('player-rank-text');
                if (rank > 0) {
                    rankText.innerHTML = `¬°Has quedado en la <span class="font-bold text-yellow-300">${rank}¬™</span> posici√≥n!`;
                } else {
                    rankText.textContent = 'Tu puntuaci√≥n ha sido guardada.';
                }
            });

            ui.gameOverlay.classList.remove('hidden-overlay');
        }

        function showMainMenu() {
            ui.gameUI.classList.add('hidden');
            const menuHTML = `
                <div class="flex flex-col justify-between h-full w-full max-w-md text-center">
                    <div class="flex-grow flex flex-col justify-center">
                        <img src="imagenes/logo.png" alt="Logo del Juego" class="w-3/4 max-w-[280px] mx-auto mb-8 sm:mb-12" onerror="this.style.display='none'; document.getElementById('fallback-title').classList.remove('hidden')">
                        <h1 id="fallback-title" class="hidden font-title text-4xl sm:text-6xl mb-12 text-yellow-300">Brawl Stars: Batalla Infinita</h1>
                        <div class="space-y-3">
                            <button onclick="showNameInputScreen()" class="menu-button w-full bg-blue-600 border-blue-800 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">Nueva Partida</button>
                            <button onclick="showInstructionsScreen()" class="menu-button w-full bg-purple-600 border-purple-800 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">Instrucciones</button>
                            <button onclick="showRankingScreen()" class="menu-button w-full bg-orange-500 border-orange-700 hover:bg-orange-400 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">Ranking</button>
                        </div>
                    </div>
                    <div class="pb-2">
                        <img src="avatares/jon.png" alt="Creador del juego" class="w-20 h-20 rounded-full mx-auto" onerror="this.style.display='none'">
                        <p class="font-title mt-2 text-lg"><span class="text-green-400">Jon</span><span class="text-gray-400"> Zabalok egina ¬©</span></p>
                    </div>
                </div>
            `;
            ui.gameOverlay.innerHTML = menuHTML;
            ui.gameOverlay.classList.remove('hidden-overlay');
        }

        function showNameInputScreen() {
            ui.gameOverlay.innerHTML = `
                <div>
                    <img src="imagenes/logo.png" alt="Logo del Juego" class="w-1/2 max-w-[180px] mx-auto mb-6">
                    <h1 class="font-title text-4xl sm:text-5xl mb-6 text-yellow-300">Elige tu Nombre</h1>
                    <input type="text" id="player-name-input" placeholder="Escribe tu nombre" class="w-full mb-6 font-title">
                    <button onclick="initGame()" class="menu-button w-full bg-green-500 border-green-700 hover:bg-green-400 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">¬°A la Batalla!</button>
                    <button onclick="showMainMenu()" class="mt-4 text-gray-400">Volver</button>
                </div>
            `;
        }

        function showInstructionsScreen() {
            ui.gameOverlay.innerHTML = `
                <div class="flex flex-col justify-between h-full w-full">
                    <div class="text-center mb-4">
                        <img src="imagenes/logo.png" alt="Logo" class="w-1/2 max-w-[150px] mx-auto">
                    </div>
                    <div class="flex-grow space-y-3 sm:space-y-4 text-left text-base sm:text-lg overflow-y-auto font-bold">
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">üéØ</span><div><strong class="text-yellow-300">OBJETIVO:</strong> ¬°Aguanta el m√°ximo de asaltos que puedas!</div></div>
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">ü§î</span><div><strong class="text-yellow-300">DECISIONES:</strong> En cada turno, un Brawler te dar√° dos opciones. ¬°Elige con cuidado!</div></div>
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">üìä</span><div><strong class="text-yellow-300">ESTAD√çSTICAS:</strong> Tus elecciones afectan a tu Vida, Ataque, Defensa y Superpoder.</div></div>
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">‚öîÔ∏è</span><div><strong class="text-yellow-300">ENEMIGOS:</strong> Despu√©s de cada turno, los enemigos atacan. ¬°La defensa es clave!</div></div>
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">üéÅ</span><div><strong class="text-yellow-300">SORPRESAS:</strong> A veces, aparecer√°n eventos y acertijos con grandes recompensas.</div></div>
                        <div class="flex items-start gap-3 sm:gap-4"><span class="text-2xl sm:text-3xl pt-1">üåü</span><div><strong class="text-yellow-300">SUPERPODER:</strong> Al 100%, ¬°√∫salo para obtener una gran ventaja y equilibrar tus stats!</div></div>
                    </div>
                    <div class="text-center mt-4 sm:mt-6">
                         <p class="font-title text-lg"><span class="text-green-400">Jon</span><span class="text-gray-400"> Zabalok egina ¬©</span></p>
                        <button onclick="showMainMenu()" class="menu-button w-full mt-4 bg-blue-600 border-blue-800 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">Entendido</button>
                    </div>
                </div>
            `;
        }

        function showRankingScreen() {
            ui.gameOverlay.innerHTML = `
                <div class="w-full flex flex-col h-full">
                    <div class="text-center mb-4">
                        <img src="imagenes/logo.png" alt="Logo" class="w-1/2 max-w-[150px] mx-auto">
                    </div>
                    <div class="w-full max-w-md bg-gray-700 rounded-lg p-4 mb-6 mx-auto flex-grow">
                        <h2 class="font-title text-2xl text-yellow-300 mb-2">üèÜ Ranking üèÜ</h2>
                        <table class="ranking-table text-lg font-bold">
                            <thead><tr><th>#</th><th class="text-left">Nombre</th><th>üíé</th><th>Asaltos</th></tr></thead>
                            <tbody id="ranking-list-table"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-center">
                        <button onclick="showMainMenu()" class="menu-button w-full max-w-xs bg-blue-600 border-blue-800 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl sm:text-2xl font-title">Volver al Men√∫</button>
                    </div>
                </div>
            `;
            displayRanking(document.getElementById('ranking-list-table'));
        }

        // --- INICIO DEL JUEGO ---
        ui.superButton.onclick = useSuper;
        ui.resolutionContinue.onclick = handleContinueClick;
        
        ui.splashLogo.addEventListener('animationend', (event) => {
            if (event.animationName === 'dropIn') {
                ui.splashLogo.classList.add('shake');
                ui.impactSound.play().catch(e => {});
                
                setTimeout(() => {
                    ui.splashScreen.style.opacity = 0;
                    ui.gameContainer.classList.remove('hidden');
                    showMainMenu();
                    setTimeout(() => ui.splashScreen.style.display = 'none', 500);
                }, 500);
            }
        });

    </script>
</body>
</html>
